---
import { getCollection } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import Header from '../components/Header.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../consts';

const allPosts = (await getCollection('blog')).sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

const featured = allPosts[0];
const hasTags = (post: any) => Array.isArray(post?.data?.tags) && post.data.tags.length > 0;
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
		<style>
			/* 2010-ish: typography + lines + underlined links */
			main {
				max-width: 72ch;
				margin: 0 auto;
				padding: 2.25rem 1rem 3.25rem;
			}

			a {
				color: inherit;
				text-decoration: underline;
				text-decoration-thickness: 1px;
				text-underline-offset: 0.2em;
			}

			a:hover {
				color: var(--accent);
			}

			.hero {
				padding: 0 0 1.25rem;
				margin: 0 0 1.5rem;
				border-bottom: 1px solid var(--border);
			}

			.kicker {
				margin: 0 0 0.5rem;
				color: var(--muted);
				font-size: 0.9rem;
				letter-spacing: 0.04em;
				text-transform: uppercase;
			}

			.title {
				margin: 0;
				font-size: 1.6rem;
				line-height: 1.2;
				max-width: 40ch;
			}

			.tagline {
				margin: 0.75rem 0 0;
				color: var(--text-secondary);
				line-height: 1.6;
				max-width: 70ch;
			}

			.navline {
				margin-top: 0.9rem;
				display: flex;
				align-items: center;
				flex-wrap: wrap;
				gap: 0.9rem;
				color: var(--muted);
				font-size: 0.95rem;
			}

			.themeSwitch {
				position: relative;
				display: inline-flex;
				align-items: center;
				margin-left: 0.2rem;
			}

			.themeToggle {
				position: relative;
				display: inline-flex;
				align-items: center;
				justify-content: center;
				width: 1.8rem;
				height: 1.6rem;
				border-radius: 999px;
				border: 1px solid transparent;
				background: transparent;
				color: inherit;
				cursor: pointer;
				padding: 0;
				font-size: 0.95rem;
				line-height: 1;
				opacity: 0.75;
				transition: color 140ms ease, border-color 140ms ease, background-color 140ms ease,
					opacity 140ms ease;
			}

			.themeToggle:hover {
				color: var(--text-primary);
				border-color: var(--border);
				background: var(--code-bg);
				opacity: 1;
			}

			.themeToggle:focus-visible {
				outline: 2px solid var(--accent);
				outline-offset: 2px;
			}

			.themeToggle::after {
				content: "";
				position: absolute;
				inset: -0.45rem;
				border-radius: 999px;
				border: 1px solid var(--accent);
				opacity: 0;
				pointer-events: none;
			}

			.themeToggle.is-pulse::after {
				animation: themePulse 420ms ease;
			}

			.themeToast {
				position: absolute;
				left: calc(100% + 0.45rem);
				top: 50%;
				transform: translateY(calc(-50% + 6px));
				padding: 0.18rem 0.55rem;
				border-radius: 999px;
				background: var(--surface);
				border: 1px solid var(--border);
				color: var(--text-primary);
				font-size: 0.7rem;
				font-family: var(--mono);
				letter-spacing: 0.12em;
				text-transform: uppercase;
				white-space: nowrap;
				opacity: 0;
				pointer-events: none;
				transition: opacity 160ms ease, transform 160ms ease;
			}

			.themeToast.is-visible {
				opacity: 1;
				transform: translateY(-50%);
			}

			@keyframes themePulse {
				from {
					opacity: 0.65;
					transform: scale(0.85);
				}
				to {
					opacity: 0;
					transform: scale(1.35);
				}
			}

			.divider {
				margin: 1.5rem 0;
				color: var(--muted);
				font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono",
					"Courier New", monospace;
				font-size: 0.9rem;
				user-select: none;
			}

			.sectionHead {
				display: flex;
				align-items: baseline;
				justify-content: space-between;
				gap: 1rem;
				margin: 1.25rem 0 0.6rem;
			}

			.sectionHead h2 {
				margin: 0;
				font-size: 0.95rem;
				letter-spacing: 0.04em;
				text-transform: uppercase;
				color: var(--muted);
			}

			.featureRow {
				padding: 0.9rem 0;
				border-top: 1px solid var(--border);
				border-bottom: 1px solid var(--border);
			}

			.meta {
				display: flex;
				align-items: baseline;
				justify-content: space-between;
				gap: 1rem;
				color: var(--muted);
				font-size: 0.9rem;
				font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono",
					"Courier New", monospace;
			}

			.hlink {
				display: inline-block;
				margin-top: 0.4rem;
				font-size: 1.15rem;
				line-height: 1.25;
				text-decoration-thickness: 2px;
			}

			.desc {
				margin: 0.4rem 0 0;
				color: var(--text-secondary);
				line-height: 1.55;
			}

			.tagsLine {
				margin-top: 0.55rem;
				color: var(--muted);
				font-size: 0.9rem;
				font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono",
					"Courier New", monospace;
			}

			.tagsLine span {
				margin-right: 0.6rem;
				white-space: nowrap;
			}

			.list {
				list-style: none;
				padding: 0;
				margin: 0;
				border-top: 1px solid var(--border);
			}

			.item {
				padding: 0.8rem 0;
				border-bottom: 1px solid var(--border);
			}

			.itemTop {
				display: flex;
				align-items: baseline;
				justify-content: space-between;
				gap: 1rem;
			}

			.itemDate {
				color: var(--muted);
				font-size: 0.9rem;
				white-space: nowrap;
				font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono",
					"Courier New", monospace;
			}

			.itemTitle a {
				text-decoration-thickness: 2px;
			}

			.itemDesc {
				margin: 0.35rem 0 0;
				color: var(--text-secondary);
				line-height: 1.55;
			}

			.empty {
				color: var(--text-secondary);
				font-style: italic;
			}

			@media (max-width: 560px) {
				.itemTop {
					flex-direction: column;
					align-items: flex-start;
					gap: 0.25rem;
				}

				.themeToast {
					left: 50%;
					top: calc(100% + 0.35rem);
					transform: translateX(-50%) translateY(6px);
				}

				.themeToast.is-visible {
					transform: translateX(-50%) translateY(0);
				}
			}
		</style>
	</head>
	<body>
		<Header />

		<main>
			<header class="hero">
				<p class="kicker">cbug.dev</p>
				<h1 class="title">Writing about security, life, and AI.</h1>
				<p class="tagline">Writeups and notes for folks who like to go deep.</p>

				<nav class="navline" aria-label="Quick links">
					<a href="/blog">/blog</a>
					<a href="/about">/about</a>
					<a href="/rss.xml">/rss</a>
					<span class="themeSwitch">
						<button
							class="themeToggle"
							type="button"
							aria-label="Switch theme"
							title="Switch theme"
							data-theme-toggle
						>
							◐
						</button>
						<span
							class="themeToast"
							data-theme-toast
							role="status"
							aria-live="polite"
							aria-atomic="true"
						></span>
					</span>
				</nav>
			</header>

			<p class="divider">────────────────────────────────────────</p>

			{
				allPosts.length === 0 ? (
					<p class="empty">No posts yet.</p>
				) : (
					<>
						<section aria-label="Latest entry">
							<div class="sectionHead">
								<h2>Latest entry</h2>
								<a href="/blog">All posts →</a>
							</div>

							<div class="featureRow">
								<div class="meta">
									<span>latest</span>
									<span><FormattedDate date={featured.data.pubDate} /></span>
								</div>

								<a class="hlink" href={`/blog/${featured.slug}/`}>{featured.data.title}</a>

								{featured.data.description ? (
									<p class="desc">{featured.data.description}</p>
								) : (
									<p class="desc">Open the post →</p>
								)}

								{hasTags(featured) && (
									<div class="tagsLine" aria-label="Tags">
										{featured.data.tags.map((t: string) => (
											<span>[{t}]</span>
										))}
									</div>
								)}
							</div>
						</section>

					</>
				)
			}
		</main>

		<Footer />
		<script is:inline>
			(() => {
				const root = document.documentElement;
				const themeOrder = ['pine', 'ember', 'slate', 'mist', 'honey'];
				const themeNames = {
					pine: 'Pine',
					ember: 'Ember',
					slate: 'Slate',
					mist: 'Mist',
					honey: 'Honey',
				};
				const toggle = document.querySelector('[data-theme-toggle]');
				const toast = document.querySelector('[data-theme-toast]');
				if (!toggle) return;

				let toastTimer = null;
				let stored = null;
				try {
					stored = localStorage.getItem('theme');
				} catch (error) {
					stored = null;
				}
				let activeTheme = stored && themeNames[stored] ? stored : 'pine';

				const pulseToggle = () => {
					toggle.classList.remove('is-pulse');
					void toggle.offsetWidth;
					toggle.classList.add('is-pulse');
				};

				const showToast = (label) => {
					if (!toast) return;
					toast.textContent = label;
					toast.classList.remove('is-visible');
					void toast.offsetWidth;
					toast.classList.add('is-visible');
					if (toastTimer) {
						window.clearTimeout(toastTimer);
					}
					toastTimer = window.setTimeout(() => {
						toast.classList.remove('is-visible');
					}, 1200);
				};

				const applyTheme = (theme, announce) => {
					const label = themeNames[theme] ?? theme;
					activeTheme = theme;
					root.dataset.theme = theme;
					try {
						localStorage.setItem('theme', theme);
					} catch (error) {
						// Ignore storage errors to keep the UI working.
					}
					toggle.setAttribute('aria-label', `Theme: ${label}. Switch theme`);
					toggle.setAttribute('title', `Theme: ${label}`);
					if (toast) {
						toast.textContent = label;
					}
					if (announce) {
						pulseToggle();
						showToast(label);
					}
				};

				applyTheme(activeTheme, false);

				toggle.addEventListener('click', () => {
					const currentIndex = themeOrder.indexOf(activeTheme);
					const nextIndex =
						currentIndex === -1 ? 0 : (currentIndex + 1) % themeOrder.length;
					const nextTheme = themeOrder[nextIndex];
					applyTheme(nextTheme, true);
				});
			})();
		</script>
	</body>
</html>
